<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物理方块弹射 (Physics Block Blaster)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            user-select: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 10;
        }
        h1 {
            margin: 0;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        p {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.8;
        }
        #score-board {
            font-size: 20px;
            font-weight: bold;
            color: #4ade80;
            margin-top: 10px;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: auto;
        }
        button {
            background: #3b82f6;
            border: none;
            padding: 10px 20px;
            color: white;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        button:active {
            transform: scale(0.95);
        }
        button.reset {
            background: #ef4444;
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 20;
            text-align: center;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui-layer">
        <h1>物理方块弹射</h1>
        <p>拖拽小球 -> 瞄准 -> 击中同色方块消除！</p>
        <div id="score-board">分数: 0</div>
    </div>
    
    <div id="message"></div>

    <div id="controls">
        <button class="reset" onclick="window.resetGame()">重置关卡</button>
    </div>
</div>

<script>
// Use an IIFE (Immediately Invoked Function Expression) to avoid global namespace pollution
(function() {
    // Module aliases
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Composites = Matter.Composites,
          Constraint = Matter.Constraint,
          Mouse = Matter.Mouse,
          MouseConstraint = Matter.MouseConstraint,
          Events = Matter.Events,
          Vector = Matter.Vector,
          Body = Matter.Body;

    // Game State
    let engine, render, runner;
    let bird, sling, firing = false;
    let score = 0;
    let colorPalette = ['#ef4444', '#3b82f6', '#fbbf24', '#a855f7']; // Red, Blue, Yellow, Purple
    
    // Rename w/h to avoid conflicts and define them within init or scope
    let gameWidth = window.innerWidth;
    let gameHeight = window.innerHeight;

    function init() {
        // Update dimensions on init
        gameWidth = window.innerWidth;
        gameHeight = window.innerHeight;

        // Create engine
        engine = Engine.create();
        engine.world.gravity.y = 1;

        // Create renderer
        render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            options: {
                width: gameWidth,
                height: gameHeight,
                wireframes: false,
                background: '#1a1a1a',
                pixelRatio: window.devicePixelRatio
            }
        });

        // Add bodies
        createLevel();

        // Mouse control
        const mouse = Mouse.create(render.canvas);
        const mouseConstraint = MouseConstraint.create(engine, {
            mouse: mouse,
            constraint: {
                stiffness: 0.2,
                render: {
                    visible: false
                }
            }
        });

        Composite.add(engine.world, mouseConstraint);

        // Keep the mouse in sync with rendering
        render.mouse = mouse;

        // Collision Events for Elimination Logic
        Events.on(engine, 'collisionStart', function(event) {
            const pairs = event.pairs;

            for (let i = 0; i < pairs.length; i++) {
                const bodyA = pairs[i].bodyA;
                const bodyB = pairs[i].bodyB;

                handleCollision(bodyA, bodyB);
            }
        });

        // Run the renderer
        Render.run(render);

        // Create runner
        runner = Runner.create();
        Runner.run(runner, engine);

        // firing logic loop
        Events.on(engine, 'afterUpdate', function() {
            if (firing && bird) {
                // If bird stops or falls off screen, reset
                if (bird.position.x > gameWidth + 100 || bird.position.y > gameHeight + 100 || (bird.speed < 0.2 && bird.position.x > 300)) {
                    resetBird();
                }
            }
        });
    }

    function createLevel() {
        Composite.clear(engine.world);
        Engine.clear(engine);

        // Walls & Ground
        const ground = Bodies.rectangle(gameWidth/2, gameHeight - 20, gameWidth, 60, { isStatic: true, render: { fillStyle: '#444' } });
        const leftWall = Bodies.rectangle(-30, gameHeight/2, 60, gameHeight, { isStatic: true });
        const rightWall = Bodies.rectangle(gameWidth + 30, gameHeight/2, 60, gameHeight, { isStatic: true });
        
        Composite.add(engine.world, [ground, leftWall, rightWall]);

        // The "Tower" of blocks (Target)
        // Stack of mixed colored blocks
        const stackX = gameWidth * 0.75;
        const stackY = gameHeight - 100;
        const blockSize = 50;
        
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 3; col++) {
                const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
                const block = Bodies.rectangle(
                    stackX + (col * blockSize), 
                    stackY - (row * blockSize), 
                    blockSize, blockSize, 
                    { 
                        render: { fillStyle: color, strokeStyle: '#000', lineWidth: 2 },
                        label: 'block',
                        customColor: color
                    }
                );
                Composite.add(engine.world, block);
            }
        }
        
        // Initial Bird
        resetBird();
    }

    function resetBird() {
        if (bird) Composite.remove(engine.world, bird);
        if (sling) Composite.remove(engine.world, sling);

        firing = false;
        
        // Pick a random color for the bird
        const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
        
        bird = Bodies.circle(200, gameHeight - 170, 20, { 
            density: 0.004,
            frictionAir: 0.01,
            restitution: 0.6,
            render: { fillStyle: color, strokeStyle: '#fff', lineWidth: 2 },
            label: 'bird',
            customColor: color
        });

        // The Sling (Elastic constraint)
        sling = Constraint.create({
            pointA: { x: 200, y: gameHeight - 170 },
            bodyB: bird,
            stiffness: 0.05,
            damping: 0.05,
            length: 1,
            render: { visible: true, lineWidth: 3, strokeStyle: '#888' }
        });

        Composite.add(engine.world, [bird, sling]);
    }

    // Detect Slingshot Release
    document.addEventListener('mouseup', () => {
        if (firing || !bird || !sling) return;

        const dist = Vector.magnitude(Vector.sub(bird.position, sling.pointA));
        if (dist > 20) {
            firing = true;
            // Detach sling after a tiny delay to let force apply
            setTimeout(() => {
                Composite.remove(engine.world, sling);
                sling = null;
            }, 20);
        }
    });

    function handleCollision(bodyA, bodyB) {
        const isBirdA = bodyA.label === 'bird';
        const isBlockA = bodyA.label === 'block';
        const isBirdB = bodyB.label === 'bird';
        const isBlockB = bodyB.label === 'block';

        // Bird hits Block
        if ((isBirdA && isBlockB) || (isBirdB && isBlockA)) {
            const birdBody = isBirdA ? bodyA : bodyB;
            const blockBody = isBlockA ? bodyA : bodyB;
            
            checkElimination(birdBody, blockBody);
        }
    }

    function checkElimination(birdBody, blockBody) {
        // Check Color Match
        if (birdBody.customColor === blockBody.customColor) {
            // Match! Eliminate block
            createExplosion(blockBody.position.x, blockBody.position.y, blockBody.customColor);
            Composite.remove(engine.world, blockBody);
            
            // Increment Score
            score += 100;
            updateScore();
        }
    }

    function createExplosion(x, y, color) {
        // Simple particle system
        const particles = [];
        for (let i = 0; i < 8; i++) {
            const particle = Bodies.circle(x, y, 5, {
                frictionAir: 0.1,
                render: { fillStyle: color }
            });
            Body.setVelocity(particle, {
                x: (Math.random() - 0.5) * 10,
                y: (Math.random() - 0.5) * 10
            });
            particles.push(particle);
        }
        Composite.add(engine.world, particles);

        // Remove particles after 1 sec
        setTimeout(() => {
            Composite.remove(engine.world, particles);
        }, 1000);
    }

    function updateScore() {
        const board = document.getElementById('score-board');
        if(board) board.innerText = '分数: ' + score;
    }

    // Expose resetGame to window so the HTML button can access it
    window.resetGame = function() {
        score = 0;
        updateScore();
        createLevel();
    };

    // Initialize logic
    window.onload = init;
    
    // Handle Resize
    window.onresize = () => {
        gameWidth = window.innerWidth;
        gameHeight = window.innerHeight;
        render.canvas.width = gameWidth;
        render.canvas.height = gameHeight;
    };

})();
</script>
</body>
</html>