3D 拟真魔方交互系统需求说明书 (PRD)

1. 项目概述

构建一个基于 WebGL (Three.js) 的 3D 魔方模拟应用。核心目标是实现**“物理拟真级”的手感**，要求魔方层的旋转必须严格跟随鼠标/手指的屏幕轨迹，且能够全视角自适应（无论从正面、背面、侧面或倒置视角操作，旋转方向均符合用户直觉）。

2. 视觉与渲染规格

模型构建：

由 27 个独立的小方块（Cubies）组成。

间隙（Spacing）：方块之间需保留约 2% 的物理间隙，透出深色内核，增强立体感。

材质：使用 PBR 标准材质（StandardMaterial），需具备一定的粗糙度（Roughness ~0.6）和微弱的金属感，模拟 ABS 塑料质感。

倒角：方块边缘需有倒角或黑色边框线（EdgesGeometry），以区分几何轮廓。

光照：包含环境光、主平行光（Key Light）和背光（Rim Light），确保 3D 空间感清晰。

3. 交互控制逻辑 (Input & Controls)

操作分离：

左键 / 单指：仅用于选中魔方某一层并进行旋转操作。

右键 / 双指：仅用于旋转摄像机视角（OrbitControls），平移（Pan）功能禁用。

滚轮：控制视角缩放。

防抖动：在鼠标按下并移动的初始阶段，需设置阈值（如 8-10px），区分“点击”与“拖拽”意图，防止误触。

4. 核心运动算法 (Core Mechanics) - 重难点

为确保“手感极佳”且无视角Bug，必须采用以下数学模型：

4.1 动态轴向判定 (Dynamic Axis Detection)

切线投影算法：当用户在某个面（Face）上滑动鼠标时，系统需计算该面法线对应的两个正交切线方向（Tangent Vectors）。

物理力矩修正（关键）：

不能简单映射 XY 轴。必须计算瞬时线速度向量。

公式：Velocity = RotationAxis × ContactPoint (叉乘)。

将计算出的 3D 速度向量投影到 2D 屏幕空间（World to Screen Projection）。

计算用户鼠标 2D 向量与投影向量的点积（Dot Product）。

判定：取点积绝对值最大者为目标旋转轴；点积的正负号决定旋转的正反方向。

目的：解决视角旋转到背面或倒置时，操作反向的问题。

4.2 旋转机制 (Pivot Implementation)

层级重组：检测到旋转轴后，动态查找所有属于该层的小方块。

枢轴（Pivot）吸附：将这些方块临时 attach 到一个中心枢轴对象上，旋转枢轴，而非单独旋转每个方块，以避免万向节锁（Gimbal Lock）。

坐标归一化：每次旋转结束后，必须对所有方块的 Position 和 Rotation 进行 Math.round 取整修正，消除浮点数累积误差，防止魔方“散架”。

5. 动画与物理反馈 (Animation & Physics)

1:1 跟随：在拖拽过程中，旋转角度应线性映射鼠标移动距离（Linear Mapping），无延迟。

磁吸归位 (Snapping)：

松开鼠标时，计算当前角度距离最近的 90° 倍数。

自动补间：如果旋转未完成，使用缓动函数（如 EaseOutQuad）在短时间内（~200ms）自动弹转到目标角度。

阈值判定：类似真实物理，超过 45° 自动去往下一格，不足 45° 弹回原位。

6. 性能要求

帧率：在主流移动端和 PC 端保持 60 FPS。

响应：交互延迟低于 16ms。

兼容性：需同时支持 Mouse Events 和 Touch Events。